<!DOCTYPE html>  <html> <head>   <title>csg.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               csg.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Constructive Solid Geometry (CSG) is a modeling technique that uses Boolean
operations like union and intersection to combine 3D solids. This library
implements CSG operations on meshes elegantly and concisely using BSP trees,
and is meant to serve as an easily understandable implementation of the
algorithm. All edge cases involving overlapping coplanar polygons in both
solids are correctly handled.</p>

<p>Example usage:</p>

<pre><code>var cube = CSG.cube();
var sphere = CSG.sphere({ radius: 1.3 });
var polygons = cube.subtract(sphere).toPolygons();
</code></pre>

<h2>Implementation Details</h2>

<p>All CSG operations are implemented in terms of two functions, <code>clipTo()</code> and
<code>invert()</code>, which remove parts of a BSP tree inside another BSP tree and swap
solid and empty space, respectively. To find the union of <code>a</code> and <code>b</code>, we
want to remove everything in <code>a</code> inside <code>b</code> and everything in <code>b</code> inside <code>a</code>,
then combine polygons from <code>a</code> and <code>b</code> into one solid:</p>

<pre><code>a.clipTo(b);
b.clipTo(a);
a.build(b.allPolygons());
</code></pre>

<p>The only tricky part is handling overlapping coplanar polygons in both trees.
The code above keeps both copies, but we need to keep them in one tree and
remove them in the other tree. To remove them from <code>b</code> we can clip the
inverse of <code>b</code> against <code>a</code>. The code for union now looks like this:</p>

<pre><code>a.clipTo(b);
b.clipTo(a);
b.invert();
b.clipTo(a);
b.invert();
a.build(b.allPolygons());
</code></pre>

<p>Subtraction and intersection naturally follow from set operations. If
union is <code>A | B</code>, subtraction is <code>A - B = ~(~A | B)</code> and intersection is
<code>A &amp; B = ~(~A | ~B)</code> where <code>~</code> is the complement operator.</p>

<h2>License</h2>

<p>Copyright (c) 2011 Evan Wallace (http://madebyevan.com/), under the MIT license.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>class CSG</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Holds a binary space partition tree representing a 3D solid. Two solids can
be combined using the <code>union()</code>, <code>subtract()</code>, and <code>intersect()</code> methods.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Construct a CSG solid from a list of <code>CSG.Polygon</code> instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">polygons</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">csg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">();</span>
  <span class="nx">csg</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="nx">polygons</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">csg</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">csg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">();</span>
    <span class="nx">csg</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">csg</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">toPolygons</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Return a new CSG solid representing space in either this solid or in the
solid <code>csg</code>. Neither this solid nor the solid <code>csg</code> are modified.</p>

<pre><code>A.union(B)

+-------+            +-------+
|       |            |       |
|   A   |            |       |
|    +--+----+   =   |       +----+
+----+--+    |       +----+       |
     |   B   |            |       |
     |       |            |       |
     +-------+            +-------+
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">union</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">csg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="nx">csg</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
    <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Return a new CSG solid representing space in this solid but not in the
solid <code>csg</code>. Neither this solid nor the solid <code>csg</code> are modified.</p>

<pre><code>A.subtract(B)

+-------+            +-------+
|       |            |       |
|   A   |            |       |
|    +--+----+   =   |    +--+
+----+--+    |       +----+
     |   B   |
     |       |
     +-------+
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">subtract</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">csg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="nx">csg</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Return a new CSG solid representing space both this solid and in the
solid <code>csg</code>. Neither this solid nor the solid <code>csg</code> are modified.</p>

<pre><code>A.intersect(B)

+-------+
|       |
|   A   |
|    +--+----+   =   +--+
+----+--+    |       +--+
     |   B   |
     |       |
     +-------+
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">intersect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">csg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">(</span><span class="nx">csg</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Return a new CSG solid with solid and empty space switched. This solid is
not modified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">inverse</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">csg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">csg</span><span class="p">.</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="nx">p</span><span class="p">.</span><span class="nx">flip</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">csg</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Construct an axis-aligned solid cuboid. Optional parameters are <code>center</code> and
<code>radius</code>, which default to <code>[0, 0, 0]</code> and <code>[1, 1, 1]</code>. The radius can be
specified using a single number or a list of three numbers, one for each axis.</p>

<p>Example code:</p>

<pre><code>var cube = CSG.cube({
  center: [0, 0, 0],
  radius: 1
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">cube</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">center</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">radius</span> <span class="o">?</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span>
           <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span> <span class="o">:</span> <span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">([</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
  <span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">(</span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="o">!!</span><span class="p">(</span><span class="nx">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="o">!!</span><span class="p">(</span><span class="nx">i</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="o">!!</span><span class="p">(</span><span class="nx">i</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
    <span class="p">}));</span>
  <span class="p">}));</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Construct a solid sphere. Optional parameters are <code>center</code>, <code>radius</code>,
<code>slices</code>, and <code>stacks</code>, which default to <code>[0, 0, 0]</code>, <code>1</code>, <code>16</code>, and <code>8</code>.
The <code>slices</code> and <code>stacks</code> parameters control the tessellation along the
longitude and latitude directions.</p>

<p>Example usage:</p>

<pre><code>var sphere = CSG.sphere({
  center: [0, 0, 0],
  radius: 1,
  slices: 16,
  stacks: 8
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">sphere</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">center</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">slices</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">slices</span> <span class="o">||</span> <span class="mi">16</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">stacks</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">stacks</span> <span class="o">||</span> <span class="mi">8</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">vertices</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">vertex</span><span class="p">(</span><span class="nx">theta</span><span class="p">,</span> <span class="nx">phi</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">theta</span> <span class="o">*=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">phi</span> <span class="o">*=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dir</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">theta</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">plus</span><span class="p">(</span><span class="nx">dir</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">r</span><span class="p">)),</span> <span class="nx">dir</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">slices</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">stacks</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">vertices</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">vertex</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">,</span> <span class="nx">j</span> <span class="o">/</span> <span class="nx">stacks</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">vertex</span><span class="p">((</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">,</span> <span class="nx">j</span> <span class="o">/</span> <span class="nx">stacks</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">stacks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">vertex</span><span class="p">((</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">,</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">stacks</span><span class="p">);</span>
      <span class="nx">vertex</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">,</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">stacks</span><span class="p">);</span>
      <span class="nx">polygons</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">(</span><span class="nx">vertices</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">(</span><span class="nx">polygons</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Construct a solid cylinder. Optional parameters are <code>start</code>, <code>end</code>,
<code>radius</code>, and <code>slices</code>, which default to <code>[0, -1, 0]</code>, <code>[0, 1, 0]</code>, <code>1</code>, and
<code>16</code>. The <code>slices</code> parameter controls the tessellation.</p>

<p>Example usage:</p>

<pre><code>var cylinder = CSG.cylinder({
  start: [0, -1, 0],
  end: [0, 1, 0],
  radius: 1,
  slices: 16
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">cylinder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">start</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">end</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">ray</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">radius</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">slices</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">slices</span> <span class="o">||</span> <span class="mi">16</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">axisZ</span> <span class="o">=</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">unit</span><span class="p">(),</span> <span class="nx">isY</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">axisZ</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">axisX</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">isY</span><span class="p">,</span> <span class="o">!</span><span class="nx">isY</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">cross</span><span class="p">(</span><span class="nx">axisZ</span><span class="p">).</span><span class="nx">unit</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">axisY</span> <span class="o">=</span> <span class="nx">axisX</span><span class="p">.</span><span class="nx">cross</span><span class="p">(</span><span class="nx">axisZ</span><span class="p">).</span><span class="nx">unit</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">axisZ</span><span class="p">.</span><span class="nx">negated</span><span class="p">());</span>
  <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">axisZ</span><span class="p">.</span><span class="nx">unit</span><span class="p">());</span>
  <span class="kd">var</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">function</span> <span class="nx">point</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">slice</span><span class="p">,</span> <span class="nx">normalBlend</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nx">slice</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">axisX</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">angle</span><span class="p">)).</span><span class="nx">plus</span><span class="p">(</span><span class="nx">axisY</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span><span class="p">)));</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">plus</span><span class="p">(</span><span class="nx">ray</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">stack</span><span class="p">)).</span><span class="nx">plus</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">r</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">normal</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">normalBlend</span><span class="p">)).</span><span class="nx">plus</span><span class="p">(</span><span class="nx">axisZ</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">normalBlend</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">normal</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">slices</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">t0</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">,</span> <span class="nx">t1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">slices</span><span class="p">;</span>
    <span class="nx">polygons</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span><span class="nx">start</span><span class="p">,</span> <span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]));</span>
    <span class="nx">polygons</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span><span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">t0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]));</span>
    <span class="nx">polygons</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span><span class="nx">end</span><span class="p">,</span> <span class="nx">point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">t0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">fromPolygons</span><span class="p">(</span><span class="nx">polygons</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h1>class Vector</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Represents a 3D vector.</p>

<p>Example usage:</p>

<pre><code>new CSG.Vector(1, 2, 3);
new CSG.Vector([1, 2, 3]);
new CSG.Vector({ x: 1, y: 2, z: 3 });
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="k">in</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">negated</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">plus</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">minus</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">times</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">a</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">a</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">a</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">dividedBy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">a</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">a</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">/</span> <span class="nx">a</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">dot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">lerp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">plus</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">times</span><span class="p">(</span><span class="nx">t</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">unit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">dividedBy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">());</span>
  <span class="p">},</span>

  <span class="nx">cross</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h1>class Vertex</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Represents a vertex of a polygon. Use your own vertex class instead of this
one to provide additional features like texture coordinates and vertex
colors. Custom vertex classes need to provide a <code>pos</code> property and <code>clone()</code>,
<code>flip()</code>, and <code>interpolate()</code> methods that behave analogous to the ones
defined by <code>CSG.Vertex</code>. This class provides <code>normal</code> so convenience
functions like <code>CSG.sphere()</code> can return a smooth vertex normal, but <code>normal</code>
is not used anywhere else.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">normal</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">normal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">normal</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">clone</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">clone</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Invert all orientation-specific data (e.g. vertex normal). Called when the
orientation of a polygon is flipped.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">flip</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">normal</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">negated</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Create a new vertex between this vertex and <code>other</code> by linearly
interpolating all properties using a parameter of <code>t</code>. Subclasses should
override this to interpolate additional properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">interpolate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">lerp</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">t</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">lerp</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">normal</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h1>class Plane</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Represents a plane in 3D space.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">normal</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">normal</span> <span class="o">=</span> <span class="nx">normal</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>CSG.Plane.EPSILON</code> is the tolerance used by <code>splitPolygon()</code> to decide if a
point is on the plane.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">EPSILON</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">5</span><span class="p">;</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">fromPoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">cross</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">unit</span><span class="p">();</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">a</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">clone</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">flip</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">normal</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">negated</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">=</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Split <code>polygon</code> by this plane if needed, then put the polygon or polygon
fragments in the appropriate lists. Coplanar polygons go into either
<code>coplanarFront</code> or <code>coplanarBack</code> depending on their orientation with
respect to this plane. Polygons in front or in back of this plane go into
either <code>front</code> or <code>back</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">splitPolygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">polygon</span><span class="p">,</span> <span class="nx">coplanarFront</span><span class="p">,</span> <span class="nx">coplanarBack</span><span class="p">,</span> <span class="nx">front</span><span class="p">,</span> <span class="nx">back</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">COPLANAR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">FRONT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BACK</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">SPANNING</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Classify each point as well as the entire polygon into one of the above
four classes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">polygonType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">pos</span><span class="p">)</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">EPSILON</span><span class="p">)</span> <span class="o">?</span> <span class="nx">BACK</span> <span class="o">:</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">EPSILON</span><span class="p">)</span> <span class="o">?</span> <span class="nx">FRONT</span> <span class="o">:</span> <span class="nx">COPLANAR</span><span class="p">;</span>
      <span class="nx">polygonType</span> <span class="o">|=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="nx">types</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Put the polygon in the correct list, splitting it when necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="p">(</span><span class="nx">polygonType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">COPLANAR</span><span class="o">:</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">polygon</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">normal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">coplanarFront</span> <span class="o">:</span> <span class="nx">coplanarBack</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">polygon</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">FRONT</span><span class="o">:</span>
        <span class="nx">front</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">polygon</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">BACK</span><span class="o">:</span>
        <span class="nx">back</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">polygon</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">SPANNING</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">ti</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">tj</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">vj</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">ti</span> <span class="o">!=</span> <span class="nx">BACK</span><span class="p">)</span> <span class="nx">f</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vi</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">ti</span> <span class="o">!=</span> <span class="nx">FRONT</span><span class="p">)</span> <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ti</span> <span class="o">!=</span> <span class="nx">BACK</span> <span class="o">?</span> <span class="nx">vi</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span> <span class="o">:</span> <span class="nx">vi</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">ti</span> <span class="o">|</span> <span class="nx">tj</span><span class="p">)</span> <span class="o">==</span> <span class="nx">SPANNING</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">vi</span><span class="p">.</span><span class="nx">pos</span><span class="p">))</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">normal</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">vj</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="nx">vi</span><span class="p">.</span><span class="nx">pos</span><span class="p">));</span>
            <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">vi</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">vj</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
            <span class="nx">f</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
            <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">clone</span><span class="p">());</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">front</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">shared</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">back</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">shared</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h1>class Polygon</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Represents a convex polygon. The vertices used to initialize a polygon must
be coplanar and form a convex loop. They do not have to be <code>CSG.Vertex</code>
instances but they must behave similarly (duck typing can be used for
customization).</p>

<p>Each convex polygon has a <code>shared</code> property, which is shared between all
polygons that are clones of each other or were split from the same polygon.
This can be used to define per-polygon properties (such as surface color).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span> <span class="nx">shared</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">vertices</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">shared</span> <span class="o">=</span> <span class="nx">shared</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">plane</span> <span class="o">=</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Plane</span><span class="p">.</span><span class="nx">fromPoints</span><span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">pos</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">vertices</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">shared</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">flip</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="nx">v</span><span class="p">.</span><span class="nx">flip</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">flip</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h1>class Node</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Holds a node in a BSP tree. A BSP tree is built from a collection of polygons
by picking a polygon to split along. That polygon (and all other coplanar
polygons) are added directly to that node and the other polygons are added to
the front and/or back subtrees. This is not a leafy BSP tree since there is
no distinction between internal and leaf nodes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">polygons</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">plane</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">front</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">back</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">polygons</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">polygons</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">();</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">plane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plane</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">front</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">back</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Convert solid space to empty space and empty space to solid space.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">invert</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">flip</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">flip</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">front</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">back</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Recursively remove all polygons in <code>polygons</code> that are inside this BSP
tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clipPolygons</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">polygons</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">)</span> <span class="k">return</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">front</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">back</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">splitPolygon</span><span class="p">(</span><span class="nx">polygons</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">front</span><span class="p">,</span> <span class="nx">back</span><span class="p">,</span> <span class="nx">front</span><span class="p">,</span> <span class="nx">back</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">)</span> <span class="nx">front</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">clipPolygons</span><span class="p">(</span><span class="nx">front</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span> <span class="nx">back</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">clipPolygons</span><span class="p">(</span><span class="nx">back</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">back</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">return</span> <span class="nx">front</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">back</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Remove all polygons in this BSP tree that are inside the other BSP tree
<code>bsp</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clipTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bsp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span> <span class="o">=</span> <span class="nx">bsp</span><span class="p">.</span><span class="nx">clipPolygons</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">bsp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">bsp</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Return a list of all polygons in this BSP tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">allPolygons</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">)</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">allPolygons</span><span class="p">());</span>
    <span class="k">return</span> <span class="nx">polygons</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Build a BSP tree out of <code>polygons</code>. When called on an existing tree, the
new polygons are filtered down to the bottom of the tree and become new
nodes there. Each set of polygons is partitioned using the first polygon
(no heuristic is used to pick a good split).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">build</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">polygons</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">polygons</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">plane</span> <span class="o">=</span> <span class="nx">polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">plane</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">front</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">back</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">plane</span><span class="p">.</span><span class="nx">splitPolygon</span><span class="p">(</span><span class="nx">polygons</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">polygons</span><span class="p">,</span> <span class="nx">front</span><span class="p">,</span> <span class="nx">back</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">front</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">front</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">front</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">back</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">back</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSG</span><span class="p">.</span><span class="nx">Node</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">back</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">back</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 